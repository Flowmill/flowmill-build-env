# llvm

ARG base_IMAGE_TAG
FROM $base_IMAGE_TAG

ARG CMAKE_BUILD_TYPE
ARG RESTRICTED_NPROC=1

WORKDIR $HOME/
COPY llvm-project/llvm llvm
COPY llvm-project/clang clang
WORKDIR $HOME/build/llvm
RUN cmake \
  -G Ninja \
  -DCMAKE_INSTALL_PREFIX:PATH=$HOME/install \
	-DCMAKE_BUILD_TYPE:STRING=${CMAKE_BUILD_TYPE} \
	-DLLVM_TARGETS_TO_BUILD="BPF;X86" \
	-DLLVM_BUILD_LLVM_DYLIB:BOOL=ON \
	-DLLVM_ENABLE_PROJECTS="clang" \
	-DLLVM_EXTERNAL_CLANG_SOURCE_DIR:PATH=$HOME/clang \
	$HOME/llvm
RUN nice ninja -j $RESTRICTED_NPROC && ninja -j $RESTRICTED_NPROC install
